let stationNamesCCW = [
  {
    "駅名": "東京",
    "よみがな": "とうきょう",
    "意味": "日本の首都を表す"
  },
  {
    "駅名": "有楽町",
    "よみがな": "ゆうらくちょう",
    "意味": "「有楽」は徳川家康の弟・有楽斎に由来"
  },
  {
    "駅名": "新橋",
    "よみがな": "しんばし",
    "意味": "「新しい橋」という意味"
  },
  {
    "駅名": "浜松町",
    "よみがな": "はままつちょう",
    "意味": "海沿いの「浜」と「松」のある町"
  },
  {
    "駅名": "田町",
    "よみがな": "たまち",
    "意味": "昔の田んぼが広がる地域の名残"
  },
  {
    "駅名": "品川",
    "よみがな": "しながわ",
    "意味": "「品川」は河川の名前が由来"
  },
  {
    "駅名": "大崎",
    "よみがな": "おおさき",
    "意味": "「崎」は岬を意味する"
  },
  {
    "駅名": "五反田",
    "よみがな": "ごたんだ",
    "意味": "「五反の田んぼ」が由来"
  },
  {
    "駅名": "目黒",
    "よみがな": "めぐろ",
    "意味": "目黒川の名前が由来"
  },
  {
    "駅名": "恵比寿",
    "よみがな": "えびす",
    "意味": "ビールブランド「ヱビス」に由来"
  },
  {
    "駅名": "渋谷",
    "よみがな": "しぶや",
    "意味": "「渋い谷」が語源"
  },
  {
    "駅名": "原宿",
    "よみがな": "はらじゅく",
    "意味": "「原っぱの宿場町」"
  },
  {
    "駅名": "代々木",
    "よみがな": "よよぎ",
    "意味": "「代々続く木々」に由来"
  },
  {
    "駅名": "新宿",
    "よみがな": "しんじゅく",
    "意味": "「新しい宿場町」"
  },
  {
    "駅名": "新大久保",
    "よみがな": "しんおおくぼ",
    "意味": "「大きな窪地」に新しく作られた町"
  },
  {
    "駅名": "高田馬場",
    "よみがな": "たかだのばば",
    "意味": "「高田氏の馬場」に由来"
  },
  {
    "駅名": "目白",
    "よみがな": "めじろ",
    "意味": "「白い馬（目白馬）」が由来"
  },
  {
    "駅名": "池袋",
    "よみがな": "いけぶくろ",
    "意味": "「池が多い場所」"
  },
  {
    "駅名": "大塚",
    "よみがな": "おおつか",
    "意味": "「大きな塚（丘）」が由来"
  },
  {
    "駅名": "巣鴨",
    "よみがな": "すがも",
    "意味": "「鴨が住む巣」に由来"
  },
  {
    "駅名": "駒込",
    "よみがな": "こまごめ",
    "意味": "「駒（馬）が込む」地名"
  },
  {
    "駅名": "田端",
    "よみがな": "たばた",
    "意味": "「田んぼの端（はた）」"
  },
  {
    "駅名": "西日暮里",
    "よみがな": "にしにっぽり",
    "意味": "「日暮らしの里」の西"
  },
  {
    "駅名": "日暮里",
    "よみがな": "にっぽり",
    "意味": "「日が暮れるまで過ごす里」"
  },
  {
    "駅名": "鶯谷",
    "よみがな": "うぐいすだに",
    "意味": "「鶯（うぐいす）が多い谷」"
  },
  {
    "駅名": "上野",
    "よみがな": "うえの",
    "意味": "「上の方にある土地」"
  },
  {
    "駅名": "御徒町",
    "よみがな": "おかちまち",
    "意味": "「御徒（武士の歩兵）の町」"
  },
  {
    "駅名": "秋葉原",
    "よみがな": "あきはばら",
    "意味": "「秋葉神社」が由来"
  },
]

let stationNames = [
  {
    "駅名": "東京",
    "よみがな": "とうきょう",
    "意味": "日本の首都を表す"
  },
  {
    "駅名": "神田",
    "よみがな": "かんだ",
    "意味": "「神田」がかんだ"
  },
  {
    "駅名": "秋葉原",
    "よみがな": "あきはばら",
    "意味": "「秋葉神社」が由来"
  },

  {
    "駅名": "御徒町",
    "よみがな": "おかちまち",
    "意味": "「御徒（武士の歩兵）の町」"
  },
  {
    "駅名": "上野",
    "よみがな": "うえの",
    "意味": "「上の方にある土地」"
  },
  {
    "駅名": "鶯谷",
    "よみがな": "うぐいすだに",
    "意味": "「鶯（うぐいす）が多い谷」"
  },
  {
    "駅名": "日暮里",
    "よみがな": "にっぽり",
    "意味": "「日が暮れるまで過ごす里」"
  },
  {
    "駅名": "西日暮里",
    "よみがな": "にしにっぽり",
    "意味": "「日暮らしの里」の西"
  },
  {
    "駅名": "田端",
    "よみがな": "たばた",
    "意味": "「田んぼの端（はた）」"
  },
  {
    "駅名": "駒込",
    "よみがな": "こまごめ",
    "意味": "「駒（馬）が込む」地名"
  },
  {
    "駅名": "巣鴨",
    "よみがな": "すがも",
    "意味": "「鴨が住む巣」に由来"
  },
  {
    "駅名": "大塚",
    "よみがな": "おおつか",
    "意味": "「大きな塚（丘）」が由来"
  },
  {
    "駅名": "池袋",
    "よみがな": "いけぶくろ",
    "意味": "「池が多い場所」"
  },
  {
    "駅名": "目白",
    "よみがな": "めじろ",
    "意味": "「白い馬（目白馬）」が由来"
  },
    {
    "駅名": "高田馬場",
    "よみがな": "たかだのばば",
    "意味": "「高田氏の馬場」に由来"
  },
  {
    "駅名": "新大久保",
    "よみがな": "しんおおくぼ",
    "意味": "「大きな窪地」に新しく作られた町"
  },
  {
    "駅名": "新宿",
    "よみがな": "しんじゅく",
    "意味": "「新しい宿場町」"
  },
  {
    "駅名": "代々木",
    "よみがな": "よよぎ",
    "意味": "「代々続く木々」に由来"
  },
  {
    "駅名": "原宿",
    "よみがな": "はらじゅく",
    "意味": "「原っぱの宿場町」"
  },
  {
    "駅名": "渋谷",
    "よみがな": "しぶや",
    "意味": "「渋い谷」が語源"
  },
  {
    "駅名": "恵比寿",
    "よみがな": "えびす",
    "意味": "ビールブランド「ヱビス」に由来"
  },
  {
    "駅名": "目黒",
    "よみがな": "めぐろ",
    "意味": "目黒川の名前が由来"
  },
  {
    "駅名": "五反田",
    "よみがな": "ごたんだ",
    "意味": "「五反の田んぼ」が由来"
  },
  {
    "駅名": "大崎",
    "よみがな": "おおさき",
    "意味": "「崎」は岬を意味する"
  },
  {
    "駅名": "品川",
    "よみがな": "しながわ",
    "意味": "「品川」は河川の名前が由来"
  },
  {
    "駅名": "田町",
    "よみがな": "たまち",
    "意味": "昔の田んぼが広がる地域の名残"
  },
  {
    "駅名": "浜松町",
    "よみがな": "はままつちょう",
    "意味": "海沿いの「浜」と「松」のある町"
  },
  {
    "駅名": "新橋",
    "よみがな": "しんばし",
    "意味": "「新しい橋」という意味"
  },
  {
    "駅名": "有楽町",
    "よみがな": "ゆうらくちょう",
    "意味": "「有楽」は徳川家康の弟・有楽斎に由来"
  }
]

const svg = document.querySelector('.yamanote-line');
const names = document.getElementsByClassName('station-name');
const fuse = svg.querySelector('.fuse');
const stations = document.querySelector('.yamanote-stations');
const title = document.querySelector('.station-title');
const rollBtn = document.getElementsByClassName('train-btn')[0];
const sound = document.querySelector('.sound');
const colors = ['#7FC342', '#a6c888', '#5a6550', '#4b8516', '#7fff0a'];

let ran = randomIntFromRange(0, stationNames.length);
let len = stations.children.length - 1;

/* Animate the fuse to reduce it */
fuse.setAttribute('stroke-dasharray', fuse.getTotalLength());
fuse.setAttribute('stroke-dashoffset', fuse.getTotalLength() * 2);

function randomIntFromRange(min, max) {
  return Math.floor(Math.random() * (max - min * 1) + min);
}

function resetActive(target, targetName) {
  const active = document.getElementsByClassName('selected-station')[0];
  const activeName = document.getElementsByClassName('selected-name')[0];

  if (active) {
    active.classList.remove('selected-station');
  }

  if (activeName) {
    activeName.classList.remove('selected-name');
  }
  
  target.classList.add('selected-station');
  targetName.classList.add('selected-name');
}

for (let c = 0; c <= len; c++) {
  // stationNames[c]['dist'] = stations.children[0].getTotalLength() * c;
  stations.children[c].addEventListener('click', (event) => {
    const name = stationNames[c]['駅名'];
    // title.textContent = name;
    resetActive(event.target, names[c]);
  })
}

function playAudio(time) {
  sound.currentTime = time;
  sound.play();
  setTimeout(() => { sound.pause(); }, 1000)
}

function startStation() {
  ran = randomIntFromRange(0, stationNames.length);

  let dist = stations.children[0].getTotalLength() * ran;
  let n = 0;

  const finished = {
    distance: 0
  }

  let start = {
    distance: dist,
    repeat: 0,
    repeatDelay: 1,
    duration: 3,
    onUpdate: () => {
      const point = fuse.getPointAtLength(finished.distance);
      createParticle(point);
    }
  }

  gsap.to(finished, start);
}

function startFuse() {
  const start = {
    distance: 0
  }

  let finished = {
    distance: fuse.getTotalLength(),
    repeat: 0,
    repeatDelay: 1,
    duration: 3,
    onUpdate: () => {
      const point = fuse.getPointAtLength(start.distance);
      createParticle(point);
      // createTrain(point);
    }
  }

  gsap.to(start, finished);
}

function createTrain(point) {
  const train = document.getElementsByClassName('train-btn')[0];
  let dup = train.cloneNode(true);

  svg.prepend(dup);

  dup.setAttribute('cx', point.x);
  dup.setAttribute('cy', point.y);
  dup.setAttribute('r', (Math.random() * 15) + 0.2);

  const dupEnd = {
    cx: '+= random(-20, 20)',
    cy: '+= random(-20, 20)',
    opacity: 0,
    duration: 'random(1, 3)',
    autoRound: false,
    onComplete: () => {
      svg.removeChild(dup);
    }
  }

  gsap.to(dup, dupEnd);
}

function createParticle(point) {
  // Create a new circle element
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  // Prepend the element to the SVG
  svg.prepend(circle);
  // // Set the coordinates of that circle
  circle.setAttribute('cx', point.x);
  circle.setAttribute('cy', point.y);
  // // Define a random radius for each circle
  circle.setAttribute('r', (Math.random() * 20) + 0.2);
  // // Define a random color
  circle.setAttribute('fill', gsap.utils.random(colors));
  
  // Animate the circle
  gsap.to(circle, {
    // Random cx based on its current position
    cx: '+=random(-20,20)',
    // Random cy based on its current position
    cy: '+=random(-20,20)',
    // Fade out
    opacity: 0,
    // Random duration for each circle
    duration: 'random(1, 3)',
    // Prevent gsap from rounding the cx & cy values
    autoRound: false,
    // Once the animation is complete
    onComplete: () => {
      // Remove the SVG element from its parent
      svg.removeChild(circle);
    }
  });
}

function toFuse() {
  gsap.to(fuse, {
    strokeDashoffset: fuse.getTotalLength(),
    duration: 3,
    repeat: 0,
  });
}

function toStation() {
  gsap.to(stations.children[ran], {
    strokeDashoffset: fuse.getTotalLength(),
    duration: 3,
    repeat: 0,
    onComplete: () => {
      console.log(stations.children[ran]);
      console.log(stationNames[stations.children.length - ran]['駅名'])
      resetActive(stations.children[ran]);
      title.textContent = stationNames[ran]['駅名'];
    }
  });
}

function startEmpty() {
  const start = {
    distance: 0
  }

  let finished = {
    distance: fuse.getTotalLength(),
    repeat: 0,
    repeatDelay: 1,
    duration: 3,
    onUpdate: () => {
      const point = fuse.getPointAtLength(start.distance);
      // createParticle(point);
      // createTrain(point);
    }
  }
}

function toEmpty() {
  let start = {
    path: '0'
  }

  let finish = {
    path: 'M232.275 259.434C237.775 257.434 240.275 244.434 241.775 238.434C244.942 228.101 252.175 206.834 253.775 202.434C255.775 196.934 259.775 183.434 260.275 177.934C260.775 172.434 265.275 151.242 265.275 147.434C265.275 143.934 262.275 136.434 268.775 126.934C276.239 116.025 280.775 103.434 274.275 97.4343C271.115 94.5169 258.775 80.4343 253.275 77.9343C249.993 76.4423 246.275 64.9343 243.775 60.9343C241.275 56.9343 235.775 52.4343 227.775 42.4343C210.173 20.4309 191.775 43.5593 189.275 45.4343C185.275 48.4343 170.775 53.9343 168.275 55.9343C166.529 57.3311 150.775 67.9343 133.275 62.4343C109.268 54.8893 92.7752 43.9343 84.7752 67.9343C83.2752 72.4343 72.2752 97.9343 71.2752 101.434C70.2752 104.934 67.0531 123.582 65.2752 127.434C62.2752 133.934 56.7752 161.434 54.7752 169.934C53.031 177.348 54.7752 203.373 54.7752 205.434C54.7752 208.434 52.7333 217.074 59.7752 228.934C69.2752 244.934 62.462 269.53 61.7752 271.934C60.7752 275.434 53.0249 310.638 58.7752 317.434C64.2752 323.934 78.2752 345.434 82.7752 357.434C87.5671 370.213 95.7752 392.434 98.7752 405.934C101.775 419.434 117.113 424.191 120.275 428.934C123.275 433.434 122.099 435.934 133.275 450.934C152.275 476.434 165.775 447.434 162.775 422.434C160.297 401.786 174.275 368.434 188.275 361.934C213.708 350.126 212.275 336.934 215.775 327.434C219.275 317.934 220.275 300.934 218.275 289.934C216.275 278.934 228.887 260.666 232.275 259.434Z'
  }

  gsap.to(start, finish)
}

rollBtn.addEventListener('click', (event) => {
  startStation();
  toStation();
});

window.addEventListener('keydown', (event) => {
  if (event.key == 't') {
    startFuse();
    toFuse();
  }
  if (event.key == 'e') {
    startEmpty();
    toEmpty();
  }
})

function attachListeners() {
  for (let i = 0; i < names.length; i++) {
    names[i].addEventListener('click', (event) => {
      console.log(event.target.textContent);
    })
  }

  console.log('attached')
}

window.addEventListener('load', attachListeners);